<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>null² - Nostr Client</title>

  <!-- nostr-tools from CDN -->
  <script type="module">
    // Try loading from different CDN sources
    async function loadNostrTools() {
      try {
        // Use jsdelivr ESM
        const poolModule = await import('https://cdn.jsdelivr.net/npm/nostr-tools@2.7.0/+esm');
        const { SimplePool, nip19 } = poolModule;

        window.NostrTools = { SimplePool, nip19 };
        console.log('NostrTools loaded from jsdelivr:', Object.keys(window.NostrTools));

        window.dispatchEvent(new Event('nostr-tools-ready'));
      } catch (e) {
        console.error('Failed to load nostr-tools from jsdelivr:', e);

        // Fallback to esm.sh
        try {
          const [poolMod, nip19Mod] = await Promise.all([
            import('https://esm.sh/nostr-tools@2.7.0/pool'),
            import('https://esm.sh/nostr-tools@2.7.0/nip19')
          ]);

          window.NostrTools = {
            SimplePool: poolMod.SimplePool,
            nip19: nip19Mod
          };
          console.log('NostrTools loaded from esm.sh:', Object.keys(window.NostrTools));

          window.dispatchEvent(new Event('nostr-tools-ready'));
        } catch (e2) {
          console.error('Failed to load nostr-tools:', e2);
          document.getElementById('loadingStatus').textContent = 'ライブラリ読み込みエラー';
          document.getElementById('loadingStatus').style.color = '#ef4444';
        }
      }
    }

    loadNostrTools();
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --accent: #06C755;
      --accent-dark: #05a648;
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --bg-tertiary: #141414;
      --bg-hover: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --text-tertiary: #71717a;
      --border: #27272a;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .icon {
      width: 24px;
      height: 24px;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    .icon-sm { width: 18px; height: 18px; }
    .icon-lg { width: 28px; height: 28px; }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .logo {
      font-weight: 700;
      font-size: 18px;
      color: var(--accent);
      letter-spacing: -0.5px;
    }

    .main {
      padding-top: 56px;
      padding-bottom: 80px;
      min-height: 100vh;
    }

    .page {
      display: none;
      min-height: calc(100vh - 136px);
    }

    .page.active { display: block; }

    .login-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
      min-height: calc(100vh - 56px);
    }

    .login-brand {
      margin-bottom: 48px;
      text-align: center;
    }

    .login-logo {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
      letter-spacing: -1px;
    }

    .login-tagline {
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .login-buttons {
      width: 100%;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .login-btn {
      width: 100%;
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      font-family: inherit;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s ease;
    }

    .login-btn.primary {
      background: var(--accent);
      color: white;
    }

    .login-btn.primary:hover {
      background: var(--accent-dark);
      transform: translateY(-1px);
    }

    .login-btn.secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .login-btn.secondary:hover {
      background: var(--bg-hover);
    }

    .login-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .login-info {
      margin-top: 24px;
      text-align: center;
      font-size: 13px;
      color: var(--text-tertiary);
      line-height: 1.6;
    }

    .profile-section {
      padding: 24px 16px;
      border-bottom: 1px solid var(--border);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .profile-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-avatar svg { color: var(--text-tertiary); }

    .profile-info {
      flex: 1;
      min-width: 0;
    }

    .profile-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .profile-npub {
      font-size: 12px;
      color: var(--text-tertiary);
      font-family: monospace;
      cursor: pointer;
    }

    .profile-npub:hover { color: var(--accent); }

    .profile-about {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .profile-actions {
      display: flex;
      gap: 12px;
    }

    .profile-btn {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .profile-btn:hover { background: var(--bg-tertiary); }

    .profile-btn.danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    .profile-btn.danger:hover { background: rgba(239, 68, 68, 0.1); }

    .section-title {
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    .timeline {
      display: flex;
      flex-direction: column;
    }

    .note {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s ease;
    }

    .note:hover { background: var(--bg-secondary); }

    .note-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }

    .note-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }

    .note-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .note-meta {
      flex: 1;
      min-width: 0;
    }

    .note-author-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .note-author {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .note-time {
      font-size: 13px;
      color: var(--text-tertiary);
      flex-shrink: 0;
    }

    .note-npub {
      font-size: 12px;
      color: var(--text-tertiary);
      font-family: monospace;
    }

    .note-content {
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 12px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .note-content a {
      color: var(--accent);
      text-decoration: none;
    }

    .note-content a:hover { text-decoration: underline; }

    .note-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-left: -8px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 13px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.15s ease;
    }

    .action-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .action-btn.liked { color: var(--danger); }
    .action-btn.liked:hover { background: rgba(239, 68, 68, 0.1); }
    .action-btn.reposted { color: var(--accent); }
    .action-btn.reposted:hover { background: rgba(6, 199, 85, 0.1); }
    .action-btn.zapped { color: var(--warning); }
    .action-btn.zapped:hover { background: rgba(245, 158, 11, 0.1); }

    .compose-fab {
      position: fixed;
      bottom: 96px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: var(--accent);
      border: none;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(6, 199, 85, 0.4);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 90;
    }

    .compose-fab:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 24px rgba(6, 199, 85, 0.5);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 200;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }

    .modal-overlay.show { display: flex; }

    .modal {
      background: var(--bg-secondary);
      width: 100%;
      max-width: 500px;
      border-radius: 16px 16px 0 0;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover { background: var(--bg-hover); }

    .modal-title {
      font-weight: 600;
      font-size: 16px;
    }

    .modal-submit {
      padding: 8px 20px;
      border-radius: 20px;
      border: none;
      background: var(--accent);
      color: white;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .modal-submit:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .modal-body {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    .compose-textarea {
      width: 100%;
      min-height: 150px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 16px;
      resize: none;
      outline: none;
      line-height: 1.6;
    }

    .compose-textarea::placeholder { color: var(--text-tertiary); }

    .compose-counter {
      text-align: right;
      font-size: 13px;
      color: var(--text-tertiary);
      padding-top: 8px;
    }

    .dm-empty {
      padding: 80px 24px;
      text-align: center;
    }

    .dm-empty svg {
      color: var(--text-tertiary);
      margin-bottom: 16px;
    }

    .dm-empty-title {
      font-weight: 600;
      margin-bottom: 8px;
    }

    .dm-empty-text {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    .wallet-section { padding: 24px 16px; }

    .wallet-card {
      background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .wallet-label {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-bottom: 8px;
    }

    .wallet-balance {
      font-size: 32px;
      font-weight: 700;
      color: var(--warning);
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .wallet-unit {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .wallet-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      font-size: 13px;
      color: var(--text-tertiary);
    }

    .wallet-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-tertiary);
    }

    .wallet-status.connected .wallet-status-dot { background: var(--accent); }
    .wallet-status.connected { color: var(--accent); }

    .wallet-form { margin-bottom: 24px; }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 16px;
      transition: border-color 0.15s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-btn {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: white;
      font-family: inherit;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }

    .form-btn:hover { background: var(--accent-dark); }

    .wallet-info {
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .wallet-info a {
      color: var(--accent);
      text-decoration: none;
    }

    .wallet-info a:hover { text-decoration: underline; }

    .edit-field { margin-bottom: 20px; }

    .edit-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .edit-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.15s;
    }

    .edit-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .edit-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(12px);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-tertiary);
      text-decoration: none;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      padding: 8px 20px;
      transition: color 0.15s;
    }

    .nav-item:hover { color: var(--text-secondary); }
    .nav-item.active { color: var(--accent); }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      z-index: 300;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      border: 1px solid var(--border);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .empty-state {
      padding: 60px 24px;
      text-align: center;
    }

    .empty-state svg {
      color: var(--text-tertiary);
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .empty-state-text {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    ::-webkit-scrollbar { width: 0; }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">null²</div>
  </header>

  <main class="main">
    <div class="page login-page active" id="loginPage">
      <div class="login-brand">
        <div class="login-logo">null²</div>
        <p class="login-tagline">分散型SNS Nostrクライアント</p>
      </div>

      <div class="login-buttons">
        <button class="login-btn primary" id="extensionLoginBtn" onclick="loginWithExtension()" disabled>
          <svg class="icon" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          NIP-07拡張機能でログイン
        </button>

        <button class="login-btn secondary" onclick="loginWithAmber()">
          <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Amberでログイン (Android)
        </button>
      </div>

      <div class="login-info">
        <p>nos2x, Alby, nos2x-fox などの<br>NIP-07対応拡張機能が必要です</p>
        <p id="loadingStatus" style="margin-top: 12px; color: var(--accent);">ライブラリ読み込み中...</p>
      </div>
    </div>

    <div class="page" id="homePage">
      <div class="profile-section">
        <div class="profile-header">
          <div class="profile-avatar" id="profileAvatar">
            <svg class="icon-lg" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </div>
          <div class="profile-info">
            <div class="profile-name" id="profileName">-</div>
            <div class="profile-npub" id="profileNpub" onclick="copyNpub()">-</div>
          </div>
        </div>
        <div class="profile-about" id="profileAbout"></div>
        <div class="profile-actions">
          <button class="profile-btn" onclick="showEditProfile()">
            <svg class="icon-sm" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            編集
          </button>
          <button class="profile-btn danger" onclick="logout()">
            <svg class="icon-sm" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            ログアウト
          </button>
        </div>
      </div>
      <div class="section-title">自分の投稿</div>
      <div class="timeline" id="myPosts"></div>
    </div>

    <div class="page" id="talkPage">
      <div class="dm-empty">
        <svg class="icon-lg" viewBox="0 0 24 24" width="48" height="48"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <div class="dm-empty-title">ダイレクトメッセージ</div>
        <div class="dm-empty-text">NIP-17 暗号化DM（準備中）</div>
      </div>
    </div>

    <div class="page" id="timelinePage">
      <div class="timeline" id="timeline"></div>
      <button class="compose-fab" onclick="showComposeModal()">
        <svg class="icon-lg" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
    </div>

    <div class="page" id="walletPage">
      <div class="wallet-section">
        <div class="wallet-card">
          <div class="wallet-label">残高</div>
          <div class="wallet-balance">
            <span id="walletBalance">---</span>
            <span class="wallet-unit">sats</span>
          </div>
          <div class="wallet-status" id="walletStatus">
            <div class="wallet-status-dot"></div>
            <span id="walletStatusText">未接続</span>
          </div>
        </div>

        <div class="wallet-form">
          <label class="form-label">NWC接続URI</label>
          <input type="text" class="form-input" id="nwcInput" placeholder="nostr+walletconnect://...">
          <button class="form-btn" onclick="connectNWC()">接続する</button>
        </div>

        <div class="wallet-info">
          <p><strong>Nostr Wallet Connect</strong></p>
          <p style="margin-top:8px">Lightning Walletと連携してZapを送れます。</p>
          <p style="margin-top:8px"><a href="https://nwc.getalby.com/apps/new?c=null2" target="_blank" rel="noopener">Alby NWC を取得 →</a></p>
        </div>
      </div>
    </div>
  </main>

  <nav class="bottom-nav" id="bottomNav" style="display:none">
    <div class="nav-item active" onclick="showPage('home')" id="navHome">
      <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      ホーム
    </div>
    <div class="nav-item" onclick="showPage('talk')" id="navTalk">
      <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      トーク
    </div>
    <div class="nav-item" onclick="showPage('timeline')" id="navTimeline">
      <svg class="icon" viewBox="0 0 24 24"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>
      タイムライン
    </div>
    <div class="nav-item" onclick="showPage('wallet')" id="navWallet">
      <svg class="icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
      おさいふ
    </div>
  </nav>

  <div class="modal-overlay" id="composeModal">
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="hideComposeModal()">
          <svg class="icon-sm" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
        <span class="modal-title">新規投稿</span>
        <button class="modal-submit" id="postBtn" onclick="postNote()" disabled>投稿</button>
      </div>
      <div class="modal-body">
        <textarea class="compose-textarea" id="composeText" placeholder="いまどうしてる？" oninput="updatePostBtn()"></textarea>
        <div class="compose-counter"><span id="charCount">0</span></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editProfileModal">
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="hideEditProfile()">
          <svg class="icon-sm" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
        <span class="modal-title">プロフィール編集</span>
        <button class="modal-submit" onclick="saveProfile()">保存</button>
      </div>
      <div class="modal-body">
        <div class="edit-field">
          <label class="edit-label">名前</label>
          <input type="text" class="edit-input" id="editName" placeholder="表示名">
        </div>
        <div class="edit-field">
          <label class="edit-label">自己紹介</label>
          <textarea class="edit-input edit-textarea" id="editAbout" placeholder="自己紹介"></textarea>
        </div>
        <div class="edit-field">
          <label class="edit-label">アイコンURL</label>
          <input type="text" class="edit-input" id="editPicture" placeholder="https://...">
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // State
    let pubkey = null;
    let profile = {};
    let profiles = {};
    let nwcUri = localStorage.getItem('nwcUri') || null;
    let likedNotes = new Set(JSON.parse(localStorage.getItem('likedNotes') || '[]'));
    let repostedNotes = new Set(JSON.parse(localStorage.getItem('repostedNotes') || '[]'));
    let timelineSub = null;
    let pool = null;
    let nip19 = null;
    let nostrToolsReady = false;

    const RELAY_URL = 'wss://yabu.me';

    // Make functions global
    window.loginWithExtension = loginWithExtension;
    window.loginWithAmber = loginWithAmber;
    window.logout = logout;
    window.showPage = showPage;
    window.showComposeModal = showComposeModal;
    window.hideComposeModal = hideComposeModal;
    window.updatePostBtn = updatePostBtn;
    window.postNote = postNote;
    window.toggleLike = toggleLike;
    window.toggleRepost = toggleRepost;
    window.sendZap = sendZap;
    window.showEditProfile = showEditProfile;
    window.hideEditProfile = hideEditProfile;
    window.saveProfile = saveProfile;
    window.connectNWC = connectNWC;
    window.copyNpub = copyNpub;

    // Wait for nostr-tools to load
    window.addEventListener('nostr-tools-ready', function() {
      console.log('nostr-tools loaded');
      nostrToolsReady = true;
      const { SimplePool, nip19: nip19Module } = window.NostrTools;
      pool = new SimplePool();
      nip19 = nip19Module;

      document.getElementById('loadingStatus').textContent = '準備完了';
      document.getElementById('extensionLoginBtn').disabled = false;

      // Check for Amber callback
      const params = new URLSearchParams(window.location.search);
      if (params.get('login') === 'amber' && params.has('pubkey')) {
        pubkey = params.get('pubkey');
        window.history.replaceState({}, '', window.location.pathname);
        onLoginSuccess();
      }

      // Restore NWC status
      if (nwcUri) {
        document.getElementById('nwcInput').value = nwcUri;
        document.getElementById('walletStatus').classList.add('connected');
        document.getElementById('walletStatusText').textContent = '接続済み';
      }
    });

    async function loginWithExtension() {
      if (!nostrToolsReady) {
        showToast('ライブラリを読み込み中です');
        return;
      }

      if (!window.nostr) {
        showToast('NIP-07拡張機能が見つかりません');
        return;
      }

      try {
        console.log('Requesting public key from extension...');
        const pk = await window.nostr.getPublicKey();
        console.log('Received public key:', pk);

        const hexRegex = /^[0-9a-fA-F]{64}$/;

        if (pk && typeof pk === 'string' && hexRegex.test(pk)) {
          pubkey = pk;
          console.log('Login successful, pubkey set');
          await onLoginSuccess();
        } else {
          console.error('Invalid public key format:', pk);
          showToast('無効な公開鍵形式です');
        }
      } catch (err) {
        console.error('Extension login error:', err);
        if (err instanceof DOMException && err.name === 'SyntaxError') {
          showToast('拡張機能との通信でエラーが発生しました。');
        } else if (err.message && err.message.toLowerCase().includes('rejected')) {
          showToast('ログインがキャンセルされました');
        } else {
          showToast(`ログインに失敗しました: ${err.message || '不明なエラー'}`);
        }
      }
    }

    function loginWithAmber() {
      if (/android/i.test(navigator.userAgent)) {
        const callback = encodeURIComponent(window.location.origin + window.location.pathname + '?login=amber');
        window.location.href = `intent:#Intent;scheme=nostrsigner;S.type=get_public_key;S.callbackUrl=${callback};end`;
      } else {
        showToast('AmberはAndroid専用アプリです');
      }
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

      document.getElementById(page + 'Page').classList.add('active');
      document.getElementById('nav' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');

      if (page === 'timeline') loadTimeline();
      else if (page === 'home') loadMyPosts();
    }

    async function onLoginSuccess() {
      document.getElementById('loginPage').classList.remove('active');
      document.getElementById('bottomNav').style.display = 'flex';
      showPage('timeline');
      await loadProfile();
      showToast('ログインしました');
    }

    function logout() {
      pubkey = null;
      profile = {};
      profiles = {};
      if (timelineSub) {
        timelineSub.close();
        timelineSub = null;
      }
      document.getElementById('bottomNav').style.display = 'none';
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('loginPage').classList.add('active');
      document.getElementById('timeline').innerHTML = '';
      document.getElementById('myPosts').innerHTML = '';
      showToast('ログアウトしました');
    }

    async function loadProfile() {
      if (!pubkey || !pool) return;

      try {
        const events = await pool.querySync([RELAY_URL], {
          kinds: [0],
          authors: [pubkey],
          limit: 1
        });

        if (events.length > 0) {
          profile = JSON.parse(events[0].content);
        }
      } catch (e) {
        console.error('Failed to load profile:', e);
      }

      updateProfileUI();
    }

    function updateProfileUI() {
      const avatar = document.getElementById('profileAvatar');
      const name = document.getElementById('profileName');
      const npubEl = document.getElementById('profileNpub');
      const about = document.getElementById('profileAbout');

      if (profile.picture) {
        avatar.innerHTML = `<img src="${profile.picture}" alt="" onerror="this.style.display='none'">`;
      }

      name.textContent = profile.name || profile.display_name || 'Anonymous';

      // npub encoding with error handling
      if (pubkey && nip19) {
        try {
          const npub = nip19.npubEncode(pubkey);
          npubEl.textContent = npub.substring(0, 20) + '...';
        } catch (e) {
          console.error('Failed to encode npub:', e);
          npubEl.textContent = pubkey.substring(0, 16) + '...';
        }
      } else {
        npubEl.textContent = '';
      }

      about.textContent = profile.about || '';
    }

    function copyNpub() {
      if (pubkey && nip19) {
        try {
          const npub = nip19.npubEncode(pubkey);
          navigator.clipboard.writeText(npub);
          showToast('npubをコピーしました');
        } catch (e) {
          console.error('Failed to encode npub:', e);
          navigator.clipboard.writeText(pubkey);
          showToast('公開鍵をコピーしました');
        }
      }
    }

    async function loadTimeline() {
      if (!pool) {
        console.error('Pool not initialized');
        return;
      }

      const container = document.getElementById('timeline');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        if (timelineSub) {
          timelineSub.close();
        }

        console.log('Connecting to relay:', RELAY_URL);
        const events = await pool.querySync([RELAY_URL], {
          kinds: [1],
          limit: 50
        });

        events.sort((a, b) => b.created_at - a.created_at);

        const authors = [...new Set(events.map(e => e.pubkey))];
        await fetchProfiles(authors);

        container.innerHTML = '';

        if (events.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg class="icon-lg" viewBox="0 0 24 24" width="48" height="48"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>
              <div class="empty-state-title">投稿がありません</div>
            </div>
          `;
          return;
        }

        events.forEach(event => renderNote(container, event));

        timelineSub = pool.subscribeMany(
          [RELAY_URL],
          [{ kinds: [1], since: Math.floor(Date.now() / 1000) }],
          {
            onevent: async (event) => {
              await fetchProfiles([event.pubkey]);
              renderNote(container, event, true);
            }
          }
        );

      } catch (e) {
        console.error('Failed to load timeline:', e);
        container.innerHTML = '<div class="empty-state"><div class="empty-state-text">読み込みに失敗しました</div></div>';
      }
    }

    async function loadMyPosts() {
      if (!pool) return;

      const container = document.getElementById('myPosts');

      if (!pubkey) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-text">ログインしてください</div></div>';
        return;
      }

      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        const events = await pool.querySync([RELAY_URL], {
          kinds: [1],
          authors: [pubkey],
          limit: 30
        });

        events.sort((a, b) => b.created_at - a.created_at);
        container.innerHTML = '';

        if (events.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg class="icon-lg" viewBox="0 0 24 24" width="48" height="48"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              <div class="empty-state-title">投稿がありません</div>
            </div>
          `;
          return;
        }

        events.forEach(event => renderNote(container, event));

      } catch (e) {
        console.error('Failed to load my posts:', e);
      }
    }

    async function fetchProfiles(pubkeys) {
      if (!pool) return;

      const toFetch = pubkeys.filter(pk => !profiles[pk]);
      if (toFetch.length === 0) return;

      try {
        const events = await pool.querySync([RELAY_URL], {
          kinds: [0],
          authors: toFetch
        });

        events.forEach(event => {
          try {
            profiles[event.pubkey] = JSON.parse(event.content);
          } catch (e) {}
        });
      } catch (e) {
        console.error('Failed to fetch profiles:', e);
      }
    }

    function renderNote(container, event, prepend = false) {
      const p = profiles[event.pubkey] || {};
      const name = p.name || p.display_name || event.pubkey.substring(0, 8);
      const picture = p.picture || '';
      const time = formatTime(event.created_at);
      const isLiked = likedNotes.has(event.id);
      const isReposted = repostedNotes.has(event.id);

      const noteEl = document.createElement('div');
      noteEl.className = 'note';
      noteEl.dataset.id = event.id;
      noteEl.innerHTML = `
        <div class="note-header">
          <div class="note-avatar">
            ${picture ? `<img src="${picture}" alt="" onerror="this.style.display='none'">` : `<svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}
          </div>
          <div class="note-meta">
            <div class="note-author-row">
              <span class="note-author">${escapeHtml(name)}</span>
              <span class="note-time">${time}</span>
            </div>
            <div class="note-npub">${event.pubkey.substring(0, 12)}...</div>
          </div>
        </div>
        <div class="note-content">${linkify(escapeHtml(event.content))}</div>
        <div class="note-actions">
          <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike(this, '${event.id}', '${event.pubkey}')">
            <svg class="icon-sm" viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>
          </button>
          <button class="action-btn ${isReposted ? 'reposted' : ''}" onclick="toggleRepost(this, '${event.id}', '${event.pubkey}')">
            <svg class="icon-sm" viewBox="0 0 24 24"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
          </button>
          <button class="action-btn" onclick="sendZap('${event.id}', '${event.pubkey}')">
            <svg class="icon-sm" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          </button>
        </div>
      `;

      if (prepend) {
        container.prepend(noteEl);
      } else {
        container.appendChild(noteEl);
      }
    }

    function showComposeModal() {
      if (!pubkey) {
        showToast('ログインしてください');
        return;
      }
      document.getElementById('composeModal').classList.add('show');
      document.getElementById('composeText').focus();
    }

    function hideComposeModal() {
      document.getElementById('composeModal').classList.remove('show');
      document.getElementById('composeText').value = '';
      updatePostBtn();
    }

    function updatePostBtn() {
      const text = document.getElementById('composeText').value;
      document.getElementById('postBtn').disabled = text.trim().length === 0;
      document.getElementById('charCount').textContent = text.length;
    }

    async function postNote() {
      const content = document.getElementById('composeText').value.trim();
      if (!content || !pubkey || !pool) return;

      try {
        const event = {
          kind: 1,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['client', 'null²']],
          content: content
        };

        const signedEvent = await window.nostr.signEvent(event);
        await pool.publish([RELAY_URL], signedEvent);

        showToast('投稿しました');
        hideComposeModal();

        setTimeout(() => loadTimeline(), 500);

      } catch (e) {
        console.error('Failed to post:', e);
        showToast('投稿に失敗しました');
      }
    }

    async function toggleLike(btn, noteId, notePubkey) {
      if (!pubkey || !pool) {
        showToast('ログインしてください');
        return;
      }

      if (likedNotes.has(noteId)) {
        showToast('すでにいいね済みです');
        return;
      }

      try {
        const event = {
          kind: 7,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['e', noteId], ['p', notePubkey]],
          content: '+'
        };

        const signedEvent = await window.nostr.signEvent(event);
        await pool.publish([RELAY_URL], signedEvent);

        likedNotes.add(noteId);
        localStorage.setItem('likedNotes', JSON.stringify([...likedNotes]));
        btn.classList.add('liked');
        showToast('いいねしました');
      } catch (e) {
        console.error('Failed to like:', e);
        showToast('いいねに失敗しました');
      }
    }

    async function toggleRepost(btn, noteId, notePubkey) {
      if (!pubkey || !pool) {
        showToast('ログインしてください');
        return;
      }

      if (repostedNotes.has(noteId)) {
        showToast('すでにリポスト済みです');
        return;
      }

      try {
        const event = {
          kind: 6,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['e', noteId, RELAY_URL], ['p', notePubkey]],
          content: ''
        };

        const signedEvent = await window.nostr.signEvent(event);
        await pool.publish([RELAY_URL], signedEvent);

        repostedNotes.add(noteId);
        localStorage.setItem('repostedNotes', JSON.stringify([...repostedNotes]));
        btn.classList.add('reposted');
        showToast('リポストしました');
      } catch (e) {
        console.error('Failed to repost:', e);
        showToast('リポストに失敗しました');
      }
    }

    async function sendZap(noteId, notePubkey) {
      if (!pubkey) {
        showToast('ログインしてください');
        return;
      }

      if (!nwcUri) {
        showToast('おさいふでNWCを接続してください');
        showPage('wallet');
        return;
      }

      showToast('Zap機能は準備中です');
    }

    function showEditProfile() {
      document.getElementById('editName').value = profile.name || '';
      document.getElementById('editAbout').value = profile.about || '';
      document.getElementById('editPicture').value = profile.picture || '';
      document.getElementById('editProfileModal').classList.add('show');
    }

    function hideEditProfile() {
      document.getElementById('editProfileModal').classList.remove('show');
    }

    async function saveProfile() {
      if (!pool) return;

      const newProfile = {
        ...profile,
        name: document.getElementById('editName').value.trim(),
        about: document.getElementById('editAbout').value.trim(),
        picture: document.getElementById('editPicture').value.trim()
      };

      try {
        const event = {
          kind: 0,
          created_at: Math.floor(Date.now() / 1000),
          tags: [],
          content: JSON.stringify(newProfile)
        };

        const signedEvent = await window.nostr.signEvent(event);
        await pool.publish([RELAY_URL], signedEvent);

        profile = newProfile;
        updateProfileUI();
        hideEditProfile();
        showToast('プロフィールを更新しました');
      } catch (e) {
        console.error('Failed to save profile:', e);
        showToast('保存に失敗しました');
      }
    }

    function connectNWC() {
      const uri = document.getElementById('nwcInput').value.trim();
      if (!uri.startsWith('nostr+walletconnect://')) {
        showToast('無効なNWC URIです');
        return;
      }

      nwcUri = uri;
      localStorage.setItem('nwcUri', uri);

      document.getElementById('walletStatus').classList.add('connected');
      document.getElementById('walletStatusText').textContent = '接続済み';
      showToast('NWCに接続しました');
    }

    function formatTime(timestamp) {
      const diff = Math.floor(Date.now() / 1000) - timestamp;
      if (diff < 60) return '今';
      if (diff < 3600) return Math.floor(diff / 60) + '分';
      if (diff < 86400) return Math.floor(diff / 3600) + '時間';
      if (diff < 604800) return Math.floor(diff / 86400) + '日';
      return new Date(timestamp * 1000).toLocaleDateString('ja-JP');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function linkify(text) {
      const urlRegex = /(https?:\/\/[^\s<]+)/g;
      return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }
  </script>
</body>
</html>
